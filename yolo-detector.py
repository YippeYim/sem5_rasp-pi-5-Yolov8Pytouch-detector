import cv2
import time
from picamera2 import Picamera2
from ultralytics import YOLO # ??? Ultralytics ??????????????????????????? YOLOv8/v5
import numpy as np

# 1. ???????????? Picamera2
# ?????????????????????????????????? YOLO (???? 640x480 ???? 640x640)
picam2 = Picamera2()
picam2.configure(picam2.create_video_configuration(main={"size": (640, 480), "format": "RGB888"}))
picam2.start()

# 2. ????????? YOLO (???????? 'nano' ??????????????????? Pi 5)
# ?????????????????? PyTorch Model ????????????
# ?????? YOLOv8:
# commu model
model = YOLO('yolov8n.pt') 

# Our model
# model = YOLO('best_custom_model.pt') 

# ?????????? YOLOv5:
# model = torch.hub.load('ultralytics/yolov5', 'yolov5n', force_reload=True)
# model.conf = 0.45  # ??????? Confidence threshold

print("YOLO Model loaded. Starting real-time detection...")

try:
    while True:
        # 3. ??????????????????
        frame = picam2.capture_array()
        
        start_time = time.time()
        
        # 4. ????????????????? YOLO
        # ??? 'device='cpu'' ?????????? CPU ??? Pi 5
        results = model(frame, verbose=False, device='cpu', conf=0.50)
        
        end_time = time.time()
        fps = 1 / (end_time - start_time)

        # 5. ??? Bounding Box ?????????
        # Ultralytics ?????????????????????????????
        annotated_frame = results[0].plot()
        
        # ??????? FPS
        cv2.putText(annotated_frame, f"FPS: {fps:.2f}", (10, 30), 
                    cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 2)
        
        # 6. ??????????????
        cv2.imshow("YOLO Detection", annotated_frame)

        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

finally:
    # 7. ?????????????????????????????????
    picam2.stop()
    cv2.destroyAllWindows()
    print("Detection process stopped.")
